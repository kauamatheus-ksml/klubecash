<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KlubeCash SDK - Browser Example</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .example-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .example-card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .example-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .status {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: 600;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .logs {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .logs h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .log-entry {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .example-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ KlubeCash SDK</h1>
            <p>Exemplo de uso no navegador</p>
        </div>

        <div class="example-grid">
            <!-- API Configuration -->
            <div class="example-card">
                <h3>‚öôÔ∏è Configura√ß√£o da API</h3>
                
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="password" id="apiKey" placeholder="kc_live_..." 
                           value="kc_live_123456789012345678901234567890123456789012345678901234567890">
                </div>
                
                <div class="form-group">
                    <label for="baseUrl">Base URL:</label>
                    <input type="text" id="baseUrl" value="https://klubecash.com/api-external/v1">
                </div>
                
                <div class="form-group">
                    <label for="timeout">Timeout (ms):</label>
                    <input type="number" id="timeout" value="30000">
                </div>
                
                <button class="btn" onclick="initializeSDK()">Inicializar SDK</button>
                <button class="btn" onclick="testConnection()">Testar Conex√£o</button>
                
                <div id="init-status"></div>
            </div>

            <!-- Basic Operations -->
            <div class="example-card">
                <h3>üìã Opera√ß√µes B√°sicas</h3>
                
                <button class="btn" onclick="getApiInfo()">Info da API</button>
                <button class="btn" onclick="checkHealth()">Sa√∫de da API</button>
                <button class="btn" onclick="getUsers()">Listar Usu√°rios</button>
                <button class="btn" onclick="getStores()">Listar Lojas</button>
                
                <div class="result-area" id="basic-results">Clique em um bot√£o para ver os resultados...</div>
            </div>

            <!-- Cashback Calculator -->
            <div class="example-card">
                <h3>üí∞ Calculadora de Cashback</h3>
                
                <div class="form-group">
                    <label for="storeSelect">Loja:</label>
                    <select id="storeSelect">
                        <option value="">Carregue as lojas primeiro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="purchaseAmount">Valor da Compra:</label>
                    <input type="number" id="purchaseAmount" value="100.00" min="0.01" step="0.01">
                </div>
                
                <button class="btn" onclick="calculateCashback()">Calcular Cashback</button>
                <button class="btn" onclick="bulkCalculate()">C√°lculo em Lote</button>
                
                <div class="result-area" id="cashback-results">Configure os valores e calcule o cashback...</div>
            </div>

            <!-- Transaction Manager -->
            <div class="example-card">
                <h3>üîÑ Gerenciador de Transa√ß√µes</h3>
                
                <div class="form-group">
                    <label for="customerEmail">Email do Cliente:</label>
                    <input type="email" id="customerEmail" placeholder="cliente@email.com">
                </div>
                
                <div class="form-group">
                    <label for="orderAmount">Valor do Pedido:</label>
                    <input type="number" id="orderAmount" value="250.00" min="0.01" step="0.01">
                </div>
                
                <button class="btn" onclick="processTransaction()">Processar Transa√ß√£o</button>
                <button class="btn" onclick="getStatistics()">Estat√≠sticas</button>
                
                <div class="result-area" id="transaction-results">Processe uma transa√ß√£o para ver os resultados...</div>
            </div>
        </div>

        <!-- Logs -->
        <div class="logs">
            <h3>üìÑ Logs do SDK</h3>
            <div id="logs-container">
                <div class="log-entry">SDK pronto para uso. Configure sua API Key e inicialize.</div>
            </div>
        </div>
    </div>

    <!-- Include the SDK -->
    <script src="../klubecash-sdk.js"></script>

    <script>
        // Global variables
        let sdk = null;
        let transactionManager = null;
        let stores = [];

        // Utility functions
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            
            const container = document.getElementById('logs-container');
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showResult(elementId, data) {
            const element = document.getElementById(elementId);
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        function showLoading(button, text = 'Carregando...') {
            button.innerHTML = `<span class="loading"></span>${text}`;
            button.disabled = true;
        }

        function hideLoading(button, text) {
            button.innerHTML = text;
            button.disabled = false;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(amount);
        }

        // SDK Functions
        async function initializeSDK() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const baseUrl = document.getElementById('baseUrl').value;
                const timeout = parseInt(document.getElementById('timeout').value);

                if (!apiKey) {
                    showStatus('init-status', 'Por favor, insira uma API Key', 'error');
                    return;
                }

                sdk = new KlubeCash.KlubeCashSDK(apiKey, {
                    baseUrl: baseUrl,
                    timeout: timeout,
                    debug: true,
                    logger: (message, level) => log(message, level)
                });

                transactionManager = new KlubeCash.KlubeCashTransactionManager(sdk);

                showStatus('init-status', 'SDK inicializado com sucesso!', 'success');
                log('SDK inicializado com configura√ß√µes personalizadas');

                // Auto-load stores
                await loadStoresForSelect();

            } catch (error) {
                showStatus('init-status', `Erro ao inicializar: ${error.message}`, 'error');
                log(`Erro ao inicializar SDK: ${error.message}`, 'error');
            }
        }

        async function testConnection() {
            if (!sdk) {
                showStatus('init-status', 'Inicialize o SDK primeiro', 'error');
                return;
            }

            const button = event.target;
            showLoading(button, 'Testando...');

            try {
                const result = await sdk.testConnection();
                
                let statusText = '';
                if (result.api_reachable) {
                    statusText += `‚úÖ API acess√≠vel (${result.response_time}ms)\n`;
                } else {
                    statusText += '‚ùå API n√£o acess√≠vel\n';
                }
                
                if (result.authentication) {
                    statusText += '‚úÖ Autentica√ß√£o bem-sucedida\n';
                } else {
                    statusText += '‚ùå Falha na autentica√ß√£o\n';
                }

                if (result.errors.length > 0) {
                    statusText += `\nErros:\n${result.errors.join('\n')}`;
                }

                showStatus('init-status', statusText.replace(/\n/g, '<br>'), 
                          result.api_reachable && result.authentication ? 'success' : 'error');

            } catch (error) {
                showStatus('init-status', `Erro no teste: ${error.message}`, 'error');
            } finally {
                hideLoading(button, 'Testar Conex√£o');
            }
        }

        async function getApiInfo() {
            if (!sdk) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            try {
                const info = await sdk.getApiInfo();
                showResult('basic-results', info);
                log('Informa√ß√µes da API obtidas');
            } catch (error) {
                showResult('basic-results', `Erro: ${error.message}`);
                log(`Erro ao obter informa√ß√µes da API: ${error.message}`, 'error');
            }
        }

        async function checkHealth() {
            if (!sdk) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            try {
                const health = await sdk.checkHealth();
                showResult('basic-results', health);
                log('Status de sa√∫de da API verificado');
            } catch (error) {
                showResult('basic-results', `Erro: ${error.message}`);
                log(`Erro ao verificar sa√∫de da API: ${error.message}`, 'error');
            }
        }

        async function getUsers() {
            if (!sdk) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            try {
                const users = await sdk.getUsers();
                showResult('basic-results', users);
                log(`${users.data.length} usu√°rios obtidos`);
            } catch (error) {
                showResult('basic-results', `Erro: ${error.message}`);
                log(`Erro ao obter usu√°rios: ${error.message}`, 'error');
            }
        }

        async function getStores() {
            if (!sdk) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            try {
                const storesResult = await sdk.getStores();
                stores = storesResult.data;
                showResult('basic-results', storesResult);
                log(`${stores.length} lojas obtidas`);
                
                // Update store select
                await loadStoresForSelect();
                
            } catch (error) {
                showResult('basic-results', `Erro: ${error.message}`);
                log(`Erro ao obter lojas: ${error.message}`, 'error');
            }
        }

        async function loadStoresForSelect() {
            if (!sdk) return;

            try {
                const storesResult = await sdk.getApprovedStores();
                const storeSelect = document.getElementById('storeSelect');
                
                storeSelect.innerHTML = '<option value="">Selecione uma loja</option>';
                
                storesResult.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.id;
                    option.textContent = `${store.trade_name} (ID: ${store.id})`;
                    storeSelect.appendChild(option);
                });

                log(`${storesResult.length} lojas aprovadas carregadas no seletor`);

            } catch (error) {
                log(`Erro ao carregar lojas: ${error.message}`, 'error');
            }
        }

        async function calculateCashback() {
            if (!sdk) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            const storeId = document.getElementById('storeSelect').value;
            const amount = parseFloat(document.getElementById('purchaseAmount').value);

            if (!storeId) {
                alert('Selecione uma loja');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Insira um valor v√°lido');
                return;
            }

            try {
                const result = await sdk.calculateCashback(parseInt(storeId), amount);
                
                const calc = result.data.cashback_calculation;
                const formatted = {
                    ...result,
                    formatted: {
                        purchase_amount: formatCurrency(amount),
                        total_cashback: formatCurrency(calc.total_cashback),
                        client_receives: formatCurrency(calc.client_receives),
                        admin_receives: formatCurrency(calc.admin_receives),
                        store_receives: formatCurrency(calc.store_receives)
                    }
                };

                showResult('cashback-results', formatted);
                log(`Cashback calculado para loja ${storeId}: ${formatCurrency(calc.total_cashback)}`);

            } catch (error) {
                showResult('cashback-results', `Erro: ${error.message}`);
                log(`Erro ao calcular cashback: ${error.message}`, 'error');
            }
        }

        async function bulkCalculate() {
            if (!sdk) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            try {
                const approvedStores = await sdk.getApprovedStores();
                
                if (approvedStores.length < 2) {
                    showResult('cashback-results', 'N√£o h√° lojas suficientes para c√°lculo em lote');
                    return;
                }

                const calculations = approvedStores.slice(0, 3).map((store, index) => ({
                    store_id: store.id,
                    amount: (index + 1) * 100 // 100, 200, 300
                }));

                const results = await sdk.bulkCalculateCashback(calculations);
                
                // Format results
                const formatted = {};
                Object.entries(results).forEach(([storeId, result]) => {
                    if (result.data) {
                        const calc = result.data.cashback_calculation;
                        formatted[storeId] = {
                            ...result,
                            formatted_cashback: formatCurrency(calc.total_cashback)
                        };
                    } else {
                        formatted[storeId] = result;
                    }
                });

                showResult('cashback-results', formatted);
                log(`C√°lculo em lote conclu√≠do para ${Object.keys(results).length} lojas`);

            } catch (error) {
                showResult('cashback-results', `Erro: ${error.message}`);
                log(`Erro no c√°lculo em lote: ${error.message}`, 'error');
            }
        }

        async function processTransaction() {
            if (!sdk || !transactionManager) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            const storeId = document.getElementById('storeSelect').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const amount = parseFloat(document.getElementById('orderAmount').value);

            if (!storeId) {
                alert('Selecione uma loja');
                return;
            }

            if (!customerEmail || !customerEmail.includes('@')) {
                alert('Insira um email v√°lido');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Insira um valor v√°lido');
                return;
            }

            try {
                const metadata = {
                    order_id: `WEB-${Date.now()}`,
                    payment_method: 'credit_card',
                    source: 'browser_example'
                };

                const result = await transactionManager.processTransaction(
                    parseInt(storeId),
                    amount,
                    customerEmail,
                    metadata
                );

                if (result.success) {
                    const transaction = result.transaction;
                    const formatted = {
                        ...result,
                        formatted_amounts: {
                            purchase_amount: formatCurrency(transaction.purchase_amount),
                            client_cashback: formatCurrency(transaction.cashback_data.cashback_calculation.client_receives)
                        }
                    };

                    showResult('transaction-results', formatted);
                    log(`Transa√ß√£o processada com sucesso: ${transaction.id}`);
                } else {
                    showResult('transaction-results', `Erro na transa√ß√£o: ${result.error}`);
                    log(`Erro na transa√ß√£o: ${result.error}`, 'error');
                }

            } catch (error) {
                showResult('transaction-results', `Erro: ${error.message}`);
                log(`Erro ao processar transa√ß√£o: ${error.message}`, 'error');
            }
        }

        async function getStatistics() {
            if (!sdk) {
                alert('Inicialize o SDK primeiro');
                return;
            }

            try {
                const stats = await sdk.getCashbackStatistics();
                showResult('transaction-results', stats);
                log(`Estat√≠sticas obtidas: ${stats.total_stores} lojas aprovadas`);
            } catch (error) {
                showResult('transaction-results', `Erro: ${error.message}`);
                log(`Erro ao obter estat√≠sticas: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('P√°gina carregada. KlubeCash SDK pronto para uso.');
            
            // Generate random email
            document.getElementById('customerEmail').value = KlubeCash.Utils.generateTestEmail();
        });
    </script>
</body>
</html>