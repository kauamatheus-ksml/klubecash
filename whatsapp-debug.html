<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klube Cash WhatsApp - Debug Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #25D366;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #25D366;
        }
        .section h3 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #25D366;
            padding-bottom: 10px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: #25D366;
            outline: none;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background: #25D366;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            margin: 5px;
        }
        button:hover {
            background: #1da851;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .preset-btn {
            background: #17a2b8;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            transition: background 0.3s;
        }
        .preset-btn:hover {
            background: #138496;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè™ Klube Cash WhatsApp Debug Tool</h1>

        <!-- Status do Bot -->
        <div class="section">
            <h3>üìä Status do Bot</h3>
            <div id="botStatus" class="status loading">Verificando conex√£o...</div>
            <button onclick="checkStatus()">üîÑ Atualizar Status</button>
            <button onclick="startAutoRefresh()" id="autoRefreshBtn">‚ñ∂Ô∏è Auto-refresh (5s)</button>
        </div>

        <!-- Configura√ß√µes -->
        <div class="section">
            <h3>‚öôÔ∏è Configura√ß√µes</h3>
            <div class="form-group">
                <label for="botUrl">URL do Bot:</label>
                <input type="text" id="botUrl" value="http://localhost:3002" placeholder="http://localhost:3002">
            </div>
            <div class="form-group">
                <label for="webhookSecret">Webhook Secret:</label>
                <input type="text" id="webhookSecret" value="klube-cash-2024" placeholder="klube-cash-2024">
            </div>
        </div>

        <!-- Teste R√°pido -->
        <div class="section">
            <h3>üß™ Teste R√°pido</h3>
            <p>Envia uma mensagem de teste para o n√∫mero configurado no c√≥digo (34991191534):</p>
            <button onclick="sendTestMessage()" id="testBtn">üöÄ Enviar Teste R√°pido</button>
        </div>

        <!-- Envio Personalizado -->
        <div class="section">
            <h3>üì± Envio Personalizado de Mensagem</h3>
            <div class="form-group">
                <label for="phoneNumber">N√∫mero do WhatsApp (apenas n√∫meros):</label>
                <input type="text" id="phoneNumber" placeholder="34991191534" maxlength="15">
                <small style="color: #666;">Exemplo: 34991191534 (sem + ou espa√ßos)</small>
            </div>
            <div class="form-group">
                <label for="message">Mensagem:</label>
                <textarea id="message" placeholder="Digite sua mensagem aqui..."></textarea>
            </div>
            <button onclick="sendCustomMessage()" id="sendBtn">üì§ Enviar Mensagem</button>
        </div>

        <!-- Mensagens Pr√©-definidas -->
        <div class="section">
            <h3>üìã Mensagens de Teste Pr√©-definidas</h3>
            <div class="presets">
                <button class="preset-btn" onclick="setPresetMessage('cashback')">
                    üí∞ Teste Cashback<br>
                    <small>Simula notifica√ß√£o de cashback recebido</small>
                </button>
                <button class="preset-btn" onclick="setPresetMessage('saldo')">
                    üí≥ Teste Consulta Saldo<br>
                    <small>Mensagem para ativar consulta de saldo</small>
                </button>
                <button class="preset-btn" onclick="setPresetMessage('menu')">
                    üè† Teste Menu<br>
                    <small>Mensagem para ativar menu principal</small>
                </button>
                <button class="preset-btn" onclick="setPresetMessage('error')">
                    ‚ùå Teste Erro<br>
                    <small>Testa tratamento de erros</small>
                </button>
            </div>
        </div>

        <!-- Log de Atividades -->
        <div class="section">
            <h3>üìù Log de Atividades</h3>
            <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
            <div id="log" class="log">Iniciando debug tool...\n</div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;

        // Adicionar timestamp ao log
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${typeIcon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            addLog('Log limpo');
        }

        // Verificar status do bot
        async function checkStatus() {
            const botUrl = document.getElementById('botUrl').value;
            const statusDiv = document.getElementById('botStatus');

            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Verificando conex√£o...';

            try {
                addLog('Verificando status do bot...');
                const response = await fetch(`${botUrl}/status`);
                const data = await response.json();

                if (data.bot_ready) {
                    statusDiv.className = 'status online';
                    statusDiv.innerHTML = `
                        ‚úÖ Bot Online<br>
                        Status: ${data.status}<br>
                        Sess√£o: ${data.session_name}<br>
                        Uptime: ${Math.floor(data.uptime)}s<br>
                        Vers√£o: ${data.version}
                    `;
                    addLog('Bot est√° online e funcionando!', 'success');
                } else {
                    statusDiv.className = 'status offline';
                    statusDiv.innerHTML = `‚ùå Bot Offline<br>Status: ${data.status}`;
                    addLog('Bot est√° offline ou desconectado', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status offline';
                statusDiv.textContent = '‚ùå Erro de Conex√£o - Verifique se o bot est√° rodando';
                addLog(`Erro ao verificar status: ${error.message}`, 'error');
            }
        }

        // Auto-refresh do status
        function startAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Auto-refresh (5s)';
                addLog('Auto-refresh desativado');
            } else {
                autoRefreshInterval = setInterval(checkStatus, 5000);
                btn.textContent = '‚è∏Ô∏è Parar Auto-refresh';
                addLog('Auto-refresh ativado (5s)');
                checkStatus(); // Primeira verifica√ß√£o imediata
            }
        }

        // Enviar teste r√°pido
        async function sendTestMessage() {
            const botUrl = document.getElementById('botUrl').value;
            const secret = document.getElementById('webhookSecret').value;
            const testBtn = document.getElementById('testBtn');

            testBtn.disabled = true;
            testBtn.textContent = '‚è≥ Enviando...';

            try {
                addLog('Enviando teste r√°pido...');

                const response = await fetch(`${botUrl}/send-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ secret })
                });

                const data = await response.json();

                if (data.success) {
                    addLog('Teste r√°pido enviado com sucesso!', 'success');
                    showMessage('Mensagem de teste enviada com sucesso!', 'success');
                } else {
                    addLog(`Erro no teste: ${data.error}`, 'error');
                    showMessage(`Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                addLog(`Erro na requisi√ß√£o: ${error.message}`, 'error');
                showMessage(`Erro de conex√£o: ${error.message}`, 'error');
            }

            testBtn.disabled = false;
            testBtn.textContent = 'üöÄ Enviar Teste R√°pido';
        }

        // Enviar mensagem personalizada
        async function sendCustomMessage() {
            const botUrl = document.getElementById('botUrl').value;
            const secret = document.getElementById('webhookSecret').value;
            const phone = document.getElementById('phoneNumber').value.trim();
            const message = document.getElementById('message').value.trim();
            const sendBtn = document.getElementById('sendBtn');

            if (!phone || !message) {
                showMessage('Preencha o n√∫mero e a mensagem!', 'error');
                return;
            }

            // Validar n√∫mero (apenas n√∫meros)
            if (!/^\d{10,15}$/.test(phone)) {
                showMessage('N√∫mero inv√°lido! Use apenas n√∫meros (10-15 d√≠gitos)', 'error');
                return;
            }

            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥ Enviando...';

            try {
                addLog(`Enviando mensagem para ${phone}...`);

                const response = await fetch(`${botUrl}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phone,
                        message: message,
                        secret: secret
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addLog(`Mensagem enviada para ${phone} com sucesso!`, 'success');
                    showMessage('Mensagem enviada com sucesso!', 'success');

                    // Limpar campos ap√≥s envio bem-sucedido
                    document.getElementById('message').value = '';
                } else {
                    addLog(`Erro no envio para ${phone}: ${data.error}`, 'error');
                    showMessage(`Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                addLog(`Erro na requisi√ß√£o: ${error.message}`, 'error');
                showMessage(`Erro de conex√£o: ${error.message}`, 'error');
            }

            sendBtn.disabled = false;
            sendBtn.textContent = 'üì§ Enviar Mensagem';
        }

        // Definir mensagens pr√©-definidas
        function setPresetMessage(type) {
            const phoneInput = document.getElementById('phoneNumber');
            const messageInput = document.getElementById('message');

            // Se n√£o h√° telefone, usar o padr√£o
            if (!phoneInput.value.trim()) {
                phoneInput.value = '5534991191534';
            }

            let presetMessage = '';

            switch(type) {
                case 'cashback':
                    presetMessage = `üéâ *Klube Cash - Cashback Recebido!*

üí∞ Parab√©ns! Voc√™ recebeu R$ 15,50 de cashback!

üõçÔ∏è Compra: Supermercado ABC
üìÖ Data: ${new Date().toLocaleDateString('pt-BR')}
üí≥ Valor da compra: R$ 155,00
üéØ % Cashback: 10%

üè™ Seu saldo total agora √©: R$ 78,90

Para consultar seu extrato completo, digite *saldo*.

Obrigado por usar o Klube Cash! üèÜ`;
                    break;

                case 'saldo':
                    presetMessage = 'saldo';
                    break;

                case 'menu':
                    presetMessage = 'Oi';
                    break;

                case 'error':
                    presetMessage = 'op√ß√£o inv√°lida para teste';
                    break;

                default:
                    presetMessage = 'Mensagem de teste';
            }

            messageInput.value = presetMessage;
            addLog(`Mensagem pr√©-definida carregada: ${type}`);
        }

        // Mostrar mensagens de feedback
        function showMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error' : 'success';
            messageDiv.textContent = text;

            // Inserir antes da primeira se√ß√£o
            const container = document.querySelector('.container');
            const firstSection = container.querySelector('.section');
            container.insertBefore(messageDiv, firstSection);

            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Verificar status ao carregar a p√°gina
        window.onload = function() {
            addLog('Debug tool carregado');
            checkStatus();
        };

        // Limpar interval ao fechar a p√°gina
        window.onbeforeunload = function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        };
    </script>
</body>
</html>