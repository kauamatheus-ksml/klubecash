<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentação da Estrutura do Projeto KlubeCash</title>
    <style>
        @media print {
            body { margin: 0; font-size: 11pt; }
            .page-break { page-break-before: always; }
            .no-print { display: none; }
        }
        
        body {
            font-family: "Times New Roman", serif;
            line-height: 1.6;
            margin: 20mm;
            color: #333;
            font-size: 12pt;
            max-width: 210mm;
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #FF7A00;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #FF7A00;
            font-size: 28pt;
            margin: 0;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 14pt;
            margin-top: 10px;
        }
        
        h1 {
            color: #FF7A00;
            border-bottom: 2px solid #FF7A00;
            padding-bottom: 8px;
            margin-top: 30px;
            font-size: 20pt;
        }
        
        h2 {
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-top: 25px;
            font-size: 16pt;
        }
        
        h3 {
            color: #555;
            margin-top: 20px;
            font-size: 14pt;
        }
        
        h4 {
            color: #666;
            margin-top: 15px;
            font-size: 12pt;
        }
        
        pre {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            overflow-x: auto;
            font-family: "Courier New", monospace;
            font-size: 9pt;
            line-height: 1.3;
            margin: 15px 0;
        }
        
        code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: "Courier New", monospace;
            font-size: 10pt;
        }
        
        pre code {
            background: none;
            padding: 0;
        }
        
        ul, ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        li {
            margin: 4px 0;
        }
        
        p {
            margin: 10px 0;
            text-align: justify;
        }
        
        strong {
            font-weight: bold;
            color: #333;
        }
        
        .toc {
            border: 1px solid #ddd;
            background: #f9f9f9;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .toc h2 {
            margin-top: 0;
            color: #FF7A00;
        }
        
        .directory-tree {
            font-family: "Courier New", monospace;
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 15px;
            line-height: 1.2;
            font-size: 9pt;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .architecture-box {
            text-align: center;
            margin: 20px 0;
            font-family: monospace;
            background: #f5f5f5;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 10pt;
        }
        
        .highlight {
            background: #fffbcc;
            padding: 15px;
            border-left: 4px solid #FF7A00;
            margin: 15px 0;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 10pt;
        }
        
        .print-instructions {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Documentação da Estrutura do Projeto KlubeCash</h1>
        <div class="subtitle">Guia Completo de Arquitetura e Implementação</div>
        <div class="subtitle">Versão 2.1.0 • 2025</div>
    </div>

    <div class="print-instructions no-print">
        <strong>📄 Para gerar PDF:</strong> Use Ctrl+P (Windows) ou Cmd+P (Mac) e selecione "Salvar como PDF" no destino.
    </div>

    <div class="toc">
        <h2>📋 Índice</h2>
        <ol>
            <li><a href="#visao-geral">Visão Geral</a></li>
            <li><a href="#arquitetura">Arquitetura do Sistema</a></li>
            <li><a href="#estrutura">Estrutura de Diretórios</a></li>
            <li><a href="#padroes">Padrões Arquiteturais</a></li>
            <li><a href="#componentes">Componentes Principais</a></li>
            <li><a href="#banco">Banco de Dados</a></li>
            <li><a href="#apis">APIs e Integrações</a></li>
            <li><a href="#seguranca">Segurança</a></li>
            <li><a href="#frontend">Frontend e UI</a></li>
            <li><a href="#mobile">Mobile (Flutter)</a></li>
            <li><a href="#replicar">Como Replicar em Outros Projetos</a></li>
        </ol>
    </div>

    <div class="page-break"></div>

    <h1 id="visao-geral">1. Visão Geral</h1>

    <p>O <strong>KlubeCash</strong> é um sistema completo de cashback desenvolvido em PHP com arquitetura MVC (Model-View-Controller). O sistema permite que clientes ganhem dinheiro de volta em compras, lojas gerenciem transações e administradores controlem todo o ecossistema.</p>

    <div class="highlight">
        <h3>🎯 Características Principais:</h3>
        <ul>
            <li>Sistema multi-usuário (Clientes, Lojas, Funcionários, Administradores)</li>
            <li>Integração com Mercado Pago e OpenPix</li>
            <li>PWA (Progressive Web App) com funcionalidades offline</li>
            <li>Aplicativo mobile em Flutter</li>
            <li>Sistema de notificações via WhatsApp</li>
            <li>Dashboard administrativo completo</li>
        </ul>
    </div>

    <h1 id="arquitetura">2. Arquitetura do Sistema</h1>

    <h2>2.1 Padrão MVC Híbrido</h2>
    <p>O sistema utiliza uma abordagem MVC adaptada:</p>

    <div class="architecture-box">
        <pre>
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    Views    │◄──►│ Controllers │◄──►│   Models    │
│ (Frontend)  │    │  (Lógica)   │    │ (Dados)     │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                    ┌─────────────┐
                    │  Database   │
                    │   (MySQL)   │
                    └─────────────┘
        </pre>
    </div>

    <h2>2.2 Fluxo de Dados:</h2>
    <ol>
        <li><strong>Entrada</strong>: Usuário interage com Views (PHP/HTML/CSS/JS)</li>
        <li><strong>Processamento</strong>: Controllers processam requisições</li>
        <li><strong>Dados</strong>: Models interagem com o banco de dados</li>
        <li><strong>Saída</strong>: Resposta retorna via Views ou APIs JSON</li>
    </ol>

    <div class="page-break"></div>

    <h1 id="estrutura">3. Estrutura de Diretórios</h1>

    <div class="directory-tree">
klubecash/
├── 📁 api/                          # APIs principais do sistema
│   ├── balance.php                  # API de saldo
│   ├── mercadopago.php             # Integração Mercado Pago
│   ├── openpix.php                 # Integração OpenPix
│   ├── transactions.php            # API de transações
│   └── users.php                   # API de usuários
│
├── 📁 api2/                         # APIs secundárias/auxiliares
│   ├── login.php                   # API de autenticação
│   ├── profile/                    # APIs de perfil
│   └── notifications.php           # API de notificações
│
├── 📁 assets/                       # Recursos estáticos
│   ├── css/                        # Folhas de estilo
│   │   ├── components/             # CSS de componentes
│   │   └── views/                  # CSS específico por view
│   ├── js/                         # JavaScript
│   │   ├── components/             # JS de componentes
│   │   └── admin/                  # JS administrativo
│   ├── images/                     # Imagens do sistema
│   └── icons/                      # Ícones PWA
│
├── 📁 auth/                         # Sistema de autenticação
│   └── google/                     # Autenticação Google OAuth
│
├── 📁 classes/                      # Classes utilitárias
│   ├── CashbackNotifier.php        # Notificações de cashback
│   ├── ImageGenerator.php          # Geração de imagens
│   └── SaldoConsulta.php          # Consulta de saldos
│
├── 📁 config/                       # Configurações do sistema
│   ├── constants.php               # Constantes globais
│   ├── database.php                # Configuração do BD
│   └── email.php                   # Configuração de email
│
├── 📁 controllers/                  # Controladores MVC
│   ├── AdminController.php         # Controle administrativo
│   ├── AuthController.php          # Controle de autenticação
│   ├── ClientController.php        # Controle de clientes
│   ├── StoreController.php         # Controle de lojas
│   └── TransactionController.php   # Controle de transações
│
├── 📁 core/                         # Núcleo do sistema
│   └── bootstrap.php               # Inicialização do sistema
│
├── 📁 models/                       # Modelos de dados
│   ├── User.php                    # Modelo de usuário
│   ├── Store.php                   # Modelo de loja
│   ├── Transaction.php             # Modelo de transação
│   └── Payment.php                 # Modelo de pagamento
│
├── 📁 utils/                        # Utilitários do sistema
│   ├── Email.php                   # Utilitários de email
│   ├── Security.php                # Segurança
│   ├── Validator.php               # Validações
│   └── PaymentProcessor.php        # Processamento de pagamentos
│
├── 📁 views/                        # Camada de apresentação
│   ├── admin/                      # Painel administrativo
│   ├── client/                     # Área do cliente
│   ├── stores/                     # Área das lojas
│   ├── auth/                       # Páginas de autenticação
│   └── components/                 # Componentes reutilizáveis
│
└── index.php                       # Página principal
    </div>

    <div class="page-break"></div>

    <h1 id="padroes">4. Padrões Arquiteturais</h1>

    <h2>4.1 MVC (Model-View-Controller)</h2>
    <pre><code class="php">// Exemplo de Controller
class AuthController {
    public static function login($email, $senha) {
        // Validação de entrada
        $validator = new Validator();
        
        // Interação com Model
        $user = new User();
        $result = $user->authenticate($email, $senha);
        
        // Retorno para View
        return $result;
    }
}</code></pre>

    <h2>4.2 Singleton Pattern (Conexão com BD)</h2>
    <pre><code class="php">class Database {
    private static $connection = null;
    
    public static function getConnection() {
        if (self::$connection === null) {
            // Criar nova conexão
            self::$connection = new PDO($dsn, $user, $pass);
        }
        return self::$connection;
    }
}</code></pre>

    <h2>4.3 Factory Pattern (Para criação de objetos)</h2>
    <pre><code class="php">class UserFactory {
    public static function create($type) {
        switch($type) {
            case 'cliente': return new Cliente();
            case 'loja': return new Loja();
            case 'admin': return new Administrador();
        }
    }
}</code></pre>

    <h1 id="componentes">5. Componentes Principais</h1>

    <h2>5.1 Sistema de Autenticação</h2>
    <div class="info">
        <strong>Localização:</strong> controllers/AuthController.php<br>
        <strong>Responsabilidades:</strong>
        <ul>
            <li>Login/logout de usuários</li>
            <li>Registro de novos usuários</li>
            <li>Recuperação de senha</li>
            <li>Gestão de sessões</li>
            <li>Autenticação Google OAuth</li>
        </ul>
    </div>

    <pre><code class="php">// Exemplo de uso
$result = AuthController::login($email, $senha);
if ($result['status']) {
    // Usuário autenticado
    header('Location: /dashboard');
}</code></pre>

    <h2>5.2 Sistema de Cashback</h2>
    <div class="info">
        <strong>Localização:</strong> classes/CashbackNotifier.php<br>
        <strong>Responsabilidades:</strong>
        <ul>
            <li>Cálculo de cashback</li>
            <li>Notificações automáticas</li>
            <li>Processamento de transações</li>
        </ul>
    </div>

    <h2>5.3 Sistema de Pagamentos</h2>
    <div class="info">
        <strong>Localização:</strong> utils/PaymentProcessor.php<br>
        <strong>Integrações:</strong>
        <ul>
            <li>Mercado Pago (PIX, cartão)</li>
            <li>OpenPix (PIX)</li>
            <li>Webhooks para confirmação</li>
        </ul>
    </div>

    <div class="page-break"></div>

    <h1 id="banco">6. Banco de Dados</h1>

    <h2>6.1 Estrutura Principal:</h2>

    <pre><code class="sql">-- Usuários do sistema
CREATE TABLE usuarios (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    senha_hash VARCHAR(255) NOT NULL,
    tipo ENUM('cliente', 'loja', 'admin', 'funcionario'),
    status ENUM('ativo', 'inativo', 'bloqueado'),
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Lojas parceiras
CREATE TABLE lojas (
    id INT PRIMARY KEY AUTO_INCREMENT,
    usuario_id INT,
    nome_fantasia VARCHAR(255) NOT NULL,
    categoria VARCHAR(100),
    porcentagem_cashback DECIMAL(5,2),
    status ENUM('pendente', 'aprovado', 'rejeitado'),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Transações de cashback
CREATE TABLE transacoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    cliente_id INT,
    loja_id INT,
    valor_compra DECIMAL(10,2),
    valor_cashback DECIMAL(10,2),
    status ENUM('pendente', 'aprovado', 'cancelado'),
    data_transacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (cliente_id) REFERENCES usuarios(id),
    FOREIGN KEY (loja_id) REFERENCES lojas(id)
);</code></pre>

    <h2>6.2 Padrões de Uso:</h2>
    <ol>
        <li><strong>Prepared Statements</strong> para segurança</li>
        <li><strong>Transações</strong> para operações complexas</li>
        <li><strong>Índices</strong> para performance</li>
        <li><strong>Foreign Keys</strong> para integridade</li>
    </ol>

    <h1 id="apis">7. APIs e Integrações</h1>

    <h2>7.1 APIs REST Internas</h2>
    <pre><code class="php">// api/exemplo.php
header('Content-Type: application/json');

try {
    // Validação de entrada
    $input = json_decode(file_get_contents('php://input'), true);
    
    // Processamento
    $result = processarRequisicao($input);
    
    // Resposta
    echo json_encode([
        'success' => true,
        'data' => $result
    ]);
} catch (Exception $e) {
    echo json_encode([
        'success' => false,
        'error' => $e->getMessage()
    ]);
}</code></pre>

    <h2>7.2 Integração Mercado Pago</h2>
    <pre><code class="php">class MercadoPagoClient {
    private $accessToken = MP_ACCESS_TOKEN;
    
    public function createPayment($data) {
        $curl = curl_init();
        curl_setopt_array($curl, [
            CURLOPT_URL => MP_BASE_URL . '/v1/payments',
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => json_encode($data),
            CURLOPT_HTTPHEADER => [
                'Authorization: Bearer ' . $this->accessToken,
                'Content-Type: application/json'
            ]
        ]);
        
        return json_decode(curl_exec($curl), true);
    }
}</code></pre>

    <div class="page-break"></div>

    <h1 id="seguranca">8. Segurança</h1>

    <h2>8.1 Proteção CSRF</h2>
    <pre><code class="php">class Security {
    public static function generateCSRFToken() {
        return bin2hex(random_bytes(32));
    }
    
    public static function validateCSRFToken($token) {
        return hash_equals($_SESSION['csrf_token'], $token);
    }
}</code></pre>

    <h2>8.2 Sanitização de Dados</h2>
    <pre><code class="php">public static function sanitizeInput($data) {
    return htmlspecialchars(strip_tags(trim($data)));
}</code></pre>

    <h2>8.3 Configurações de Sessão Segura</h2>
    <pre><code class="php">// config/constants.php
ini_set('session.cookie_httponly', 1);
ini_set('session.cookie_secure', 1);
ini_set('session.cookie_samesite', 'Strict');</code></pre>

    <h1 id="frontend">9. Frontend e UI</h1>

    <h2>9.1 Arquitetura CSS</h2>
    <div class="directory-tree">
assets/css/
├── mobile-first.css        # Base responsiva
├── components/            # Componentes UI
│   ├── toast.css         # Notificações
│   └── sidebar.css       # Navegação
└── views/                # Estilos por página
    ├── admin/
    ├── client/
    └── stores/
    </div>

    <h2>9.2 JavaScript Modular</h2>
    <pre><code class="javascript">// assets/js/components/toast.js
class Toast {
    static show(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
    }
}</code></pre>

    <h2>9.3 PWA (Progressive Web App)</h2>
    <pre><code class="javascript">// pwa/sw.js - Service Worker
self.addEventListener('install', event => {
    event.waitUntil(
        caches.open('klube-cash-v1').then(cache => {
            return cache.addAll([
                '/',
                '/cliente/dashboard',
                '/assets/css/main.css',
                '/assets/js/main.js'
            ]);
        })
    );
});</code></pre>

    <div class="page-break"></div>

    <h1 id="mobile">10. Mobile (Flutter)</h1>

    <h2>10.1 Arquitetura Clean Architecture</h2>
    <div class="directory-tree">
lib/
├── core/                  # Núcleo da aplicação
│   ├── constants/        # Constantes
│   ├── network/          # Cliente HTTP
│   ├── utils/            # Utilitários
│   └── widgets/          # Widgets base
│
├── features/             # Features por domínio
│   ├── auth/
│   │   ├── data/         # Fontes de dados
│   │   ├── domain/       # Regras de negócio
│   │   └── presentation/ # UI e Estado
│   ├── dashboard/
│   ├── cashback/
│   └── stores/
│
└── main.dart             # Ponto de entrada
    </div>

    <h2>10.2 Exemplo de Feature:</h2>
    <pre><code class="dart">// features/auth/presentation/providers/auth_provider.dart
class AuthProvider extends ChangeNotifier {
  final LoginUseCase _loginUseCase;
  
  Future&lt;void&gt; login(String email, String password) async {
    final result = await _loginUseCase(
      LoginParams(email: email, password: password)
    );
    
    result.fold(
      (failure) => _handleError(failure),
      (user) => _handleSuccess(user),
    );
  }
}</code></pre>

    <h1 id="replicar">11. Como Replicar em Outros Projetos</h1>

    <h2>11.1 Estrutura Base Recomendada</h2>
    <div class="directory-tree">
projeto/
├── config/              # Configurações
│   ├── constants.php    # Constantes globais
│   └── database.php     # Conexão BD
├── core/                # Núcleo
│   └── bootstrap.php    # Inicialização
├── controllers/         # Controladores
├── models/             # Modelos
├── views/              # Views
│   └── components/     # Componentes
├── utils/              # Utilitários
├── assets/             # Recursos estáticos
└── api/                # APIs
    </div>

    <h2>11.2 Padrões para Adotar</h2>

    <h3>A. Configuração Centralizada</h3>
    <pre><code class="php">// config/constants.php
define('DB_HOST', 'localhost');
define('SITE_URL', 'https://seusite.com');
define('EMAIL_FROM', 'noreply@seusite.com');</code></pre>

    <h3>B. Bootstrap de Inicialização</h3>
    <pre><code class="php">// core/bootstrap.php
require_once 'config/constants.php';
require_once 'config/database.php';

// Autoload de classes
spl_autoload_register(function($class) {
    $paths = ['controllers/', 'models/', 'utils/'];
    foreach($paths as $path) {
        $file = $path . $class . '.php';
        if (file_exists($file)) {
            require_once $file;
            break;
        }
    }
});</code></pre>

    <h3>C. Controller Base</h3>
    <pre><code class="php">abstract class BaseController {
    protected function validateInput($data, $rules) {
        return Validator::validate($data, $rules);
    }
    
    protected function jsonResponse($data, $status = 200) {
        header('Content-Type: application/json');
        http_response_code($status);
        echo json_encode($data);
        exit;
    }
}</code></pre>

    <div class="page-break"></div>

    <h2>11.3 Checklist para Implementação</h2>

    <div class="warning">
        <h3>📋 Essencial:</h3>
        <ul>
            <li>☐ Configuração de constantes centralizadas</li>
            <li>☐ Sistema de autoload ou bootstrap</li>
            <li>☐ Conexão segura com banco de dados</li>
            <li>☐ Validação e sanitização de entrada</li>
            <li>☐ Sistema de sessões seguro</li>
            <li>☐ Estrutura MVC básica</li>
        </ul>
    </div>

    <div class="info">
        <h3>⭐ Recomendado:</h3>
        <ul>
            <li>☐ Sistema de logs</li>
            <li>☐ Cache de consultas</li>
            <li>☐ Compressão de assets</li>
            <li>☐ Proteção CSRF</li>
            <li>☐ Rate limiting para APIs</li>
            <li>☐ Backup automático</li>
        </ul>
    </div>

    <div class="highlight">
        <h3>🚀 Avançado:</h3>
        <ul>
            <li>☐ PWA com Service Workers</li>
            <li>☐ Sistema de notificações</li>
            <li>☐ Integração com APIs de pagamento</li>
            <li>☐ Dashboard administrativo</li>
            <li>☐ Sistema de relatórios</li>
        </ul>
    </div>

    <h1>🎯 Conclusão</h1>

    <p>A estrutura do KlubeCash demonstra um sistema robusto e escalável que pode servir como base para diversos tipos de projetos web. Os padrões adotados garantem:</p>

    <ul>
        <li><strong>Maintibilidade</strong>: Código organizado e bem estruturado</li>
        <li><strong>Segurança</strong>: Práticas de segurança em todas as camadas</li>
        <li><strong>Escalabilidade</strong>: Arquitetura que suporta crescimento</li>
        <li><strong>Reutilização</strong>: Componentes modulares e reutilizáveis</li>
        <li><strong>Performance</strong>: Otimizações de cache e consultas</li>
    </ul>

    <p>Para implementar em outros projetos, recomenda-se adaptar os componentes conforme a necessidade específica, mantendo sempre os princípios de segurança e boas práticas apresentados nesta documentação.</p>

    <div class="footer">
        <p><strong>Desenvolvido por:</strong> Equipe KlubeCash</p>
        <p><strong>Versão:</strong> 2.1.0 • <strong>Data:</strong> 2025 • <strong>Licença:</strong> Proprietária</p>
    </div>

</body>
</html>